{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center rounded-top-4">
                    <h4 class="mb-0">Formulario de Producto</h4>
                </div>
                <div class="card-body p-4">

                    {% if mensaje %}
                    <div class="alert alert-success text-center">
                        {{ mensaje }}
                    </div>
                    {% endif %}

                    <form novalidate action="{% url 'productos:formulario' %}" method="post">
                        {% csrf_token %}

                        <!-- CAMPOS AUTOCOMPLETADOS -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">C√≥digo DUN</label>
                            <input type="text" id="id_cod_dun" name="cod_dun" class="form-control" placeholder="Ingrese DUN">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">C√≥digo EAN</label>
                            <input type="text" id="id_cod_ean_display" class="form-control bg-light" readonly>
                            <input type="hidden" id="id_cod_ean" name="cod_ean">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">C√≥digo Sistema</label>
                            <input type="text" id="id_cod_sistema_display" class="form-control bg-light" readonly>
                            <input type="hidden" id="id_cod_sistema" name="cod_sistema">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Descripci√≥n</label>
                            <input type="text" id="id_descripcion_display" class="form-control bg-light" readonly>
                            <input type="hidden" id="id_descripcion" name="descripcion">
                        </div>

                        <!-- CAMPOS DEL FORM DJANGO -->
                        {% for field in form %}
                        {% if field.name not in 'cod_dun cod_ean cod_sistema descripcion' %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in field.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}

                       <div class="text-center mt-4">
                    <a href="{% url 'productos:index'%}" 
                    class="btn btn-secondary px-4 py-2 rounded-pill me-2">
                        ‚Üê Volver al Inventario
                    </a>
                    <button type="submit" 
                            class="btn btn-primary px-5 py-2 rounded-pill">
                        üíæ Guardar
                    </button>
                </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- ===========================================
     SCRIPT DE AUTOCOMPLETADO Y C√ÅLCULO STOCK
=========================================== -->
<script>

    document.addEventListener("DOMContentLoaded", () => {

    // ====== Multiplicaci√≥n autom√°tica unidad * pack ======
    const cajas = document.getElementById('id_cajas');
    const factorx = document.getElementById('id_factorx');
    const stockFisico = document.getElementById('id_stock_fisico');

    const actualizarStock = () => {
        const c = parseFloat(cajas?.value) || 0;
        const f = parseFloat(factorx?.value) || 0;
        if (stockFisico) stockFisico.value = (c * f).toFixed(2);
    };

    if (cajas && factorx && stockFisico) {
        cajas.addEventListener('input', actualizarStock);
        factorx.addEventListener('input', actualizarStock);
    }

    // ====== Autocompletado por c√≥digo DUN ======
    const codDunInput = document.getElementById('id_cod_dun');
    let buscandoProducto = false; // Evita m√∫ltiples consultas

    const limpiarCampos = () => {
        const campos = ['cod_ean', 'cod_sistema', 'descripcion'];
        campos.forEach(c => {
            const input = document.getElementById(`id_${c}`);
            const display = document.getElementById(`id_${c}_display`);
            if (input) input.value = '';
            if (display) display.value = '';
        });
    };

    const asignarCampos = (r) => {
        document.getElementById('id_cod_ean').value = r.cod_ean || '';
        document.getElementById('id_cod_ean_display').value = r.cod_ean || '';

        document.getElementById('id_cod_sistema').value = r.cod_sistema || '';
        document.getElementById('id_cod_sistema_display').value = r.cod_sistema || '';

        document.getElementById('id_descripcion').value = r.descripcion || '';
        document.getElementById('id_descripcion_display').value = r.descripcion || '';
    };

    codDunInput.addEventListener('change', () => {
        if (buscandoProducto) return;
        buscandoProducto = true;

        const codDun = codDunInput.value.trim();
        if (!codDun) {
            buscandoProducto = false;
            return;
        }

        fetch("{% url 'productos:buscar_producto' %}?cod_dun=" + codDun)
            .then(response => response.json())
            .then(data => {
                let resultados = data.resultados || [];

                // ====== Eliminar productos duplicados ======
                // (usando cod_sistema como identificador √∫nico)
                const productosUnicos = [];
                const codigosUnicos = new Set();

                resultados.forEach(r => {
                    const clave = r.cod_sistema || r.cod_ean;
                    if (!codigosUnicos.has(clave)) {
                        codigosUnicos.add(clave);
                        productosUnicos.push(r);
                    }
                });

                if (productosUnicos.length === 0) {
                    limpiarCampos();
                    alert('‚ö†Ô∏è No se encontr√≥ ning√∫n producto con ese c√≥digo DUN.');
                } 
                else if (productosUnicos.length === 1) {
                    asignarCampos(productosUnicos[0]);
                } 
                else {
                    let opciones = "üîç Se encontraron varios productos con este DUN (sin duplicar):\n\n";
                    productosUnicos.forEach((r, i) => {
                        opciones += `${i + 1}. ${r.descripcion} ‚Äî Sistema: ${r.cod_sistema} ‚Äî EAN: ${r.cod_ean}\n`;
                    });
                    opciones += "\nIngrese el n√∫mero del producto que desea usar:";

                    const seleccion = prompt(opciones);
                    const indice = parseInt(seleccion) - 1;

                    if (!isNaN(indice) && indice >= 0 && indice < productosUnicos.length) {
                        asignarCampos(productosUnicos[indice]);
                    } else {
                        alert('‚ö†Ô∏è Selecci√≥n no v√°lida.');
                    }
                }
            })
            .catch(error => {
                console.error('Error al buscar producto:', error);
                alert('‚ùå Ocurri√≥ un error al buscar el producto.');
            })
            .finally(() => buscandoProducto = false);
    });

    // ====== Campos que usan esc√°ner ======
    const camposScanner = ['id_cod_dun', 'id_cod_ean', 'id_ubicacion'];
    camposScanner.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
            campo.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!buscandoProducto) campo.dispatchEvent(new Event('change'));
                }
            });
        }
    });
});
   

    const limpiarCampos = () => {
        const campos = ['cod_ean', 'cod_sistema', 'descripcion'];
        campos.forEach(c => {
            const input = document.getElementById(`id_${c}`);
            const display = document.getElementById(`id_${c}_display`);
            if (input) input.value = '';
            if (display) display.value = '';
        });
    };

    const asignarCampos = (r) => {
        document.getElementById('id_cod_ean').value = r.cod_ean;
        document.getElementById('id_cod_ean_display').value = r.cod_ean;

        document.getElementById('id_cod_sistema').value = r.cod_sistema;
        document.getElementById('id_cod_sistema_display').value = r.cod_sistema;

        document.getElementById('id_descripcion').value = r.descripcion;
        document.getElementById('id_descripcion_display').value = r.descripcion;
    };
</script>



{% endblock %}


 