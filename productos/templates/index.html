{% extends 'base.html'%}

{% block content %}

<br>
<!-- <a href="{% url 'productos:formulario'%}" class="btn btn-dark btn-sm"> Nuevo Ingreso</a> -->
<!-- <a href="{% url 'productos:exportar_excel' %}" class="btn btn-dark btn-sm">üìä Exportar a Excel</a> -->
<!-- <a href="{% url 'resumen_view' %}" class="btn btn-dark btn-sm">üìä Resumen</a> -->

<!-- <form
  action="{% url 'productos:importar_excel' %}"
  method="post"
  enctype="multipart/form-data"
  class="d-inline"
>
  {% csrf_token %}
  <input type="file" name="excel_file" accept=".xlsx,.xls" required class="form-control-file mb-2">
  <button type="submit" class="btn btn-dark btn-sm">
    üì• Importar Excel
  </button>
</form>
<form action="{% url 'productos:eliminar_todos' %}" method="post" class="d-inline" 
      onsubmit="return confirm('‚ö†Ô∏è ¬øSeguro que quieres borrar TODOS los productos? Esta acci√≥n no se puede deshacer.');">
  {% csrf_token %}
  <button type="submit" class="btn btn-dark btn-sm">
    üóëÔ∏è Borrar todos
  </button>
</form> -->




{% if user.is_authenticated %}
  <!-- <form method="post" action="{% url 'logout' %}" class="d-inline">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger btn-sm ">
      <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
    </button>
  </form> -->
{% endif %}



 <div class="mb-3">
    <label for="globalSearch" class="form-label"></label>
    <input type="search" id="globalSearch" class="form-control" placeholder="Buscar en la tabla...">
</div>
<div class="mb-3">
  <button id="startScan" class="btn btn-dark btn-sm">üì∑ Escanear c√≥digo</button>
  <button id="stopScan" class="btn btn-danger btn-sm" disabled>‚õî Detener</button>
  <small id="scanStatus" class="text-muted ms-2">C√°mara inactiva</small>
</div>

<div id="scannerContainer" class="mb-3" style="display:none;">
  <video id="video" autoplay playsinline style="width:100%;max-width:400px;border-radius:8px;background:#000;"></video>
</div>




<div class="table-scroll">
   
    <table class="table table-striped table-hover mb-0">
        <thead class="table-dark">
            <tr>
                <th>Categoria</th>
                <th>Empresa</th>
                <th>Ubicacion</th>
                <th>Cod_Ean</th>
                <th>Cod_Dun</th>
                <th>Cod_Sistema</th>
                <th>Descripcion</th>
                <th>Unidad</th>
                <th>Pack</th>
                <th>FactorX</th>
                <th>Cajas</th>
                <th>Saldo</th>
                <th>Stock_Fisico</th>
                <th>Observacion</th>
                <th>Fecha_Venc</th>
                <th>Fecha_Imp</th>
                <th>Contenedor</th>
                <th>Fecha_Inv</th>
                <th>Encargado</th>
                <th>Acciones</th>
            </tr>
        </thead>
    
        <tboby>
        {% for producto in productos%}
        
        <tr>
            
            <td>{{ producto.categoria }}</td>
            <td>{{ producto.empresa }}</td>
            <td>{{ producto.ubicacion }}</td>
            <td>{{ producto.cod_ean }}</td>
            <td>
                <a href="{% url 'productos:detalle' producto.id%}">
                    
                    {{ producto.cod_dun }}
                </a>
            </td>
            <td>{{ producto.cod_sistema }}</td>
            <td>{{ producto.descripcion }}</td>
            <td>{{ producto.unidad }}</td>
            <td>{{ producto.pack }}</td>
            <td>{{ producto.factorx }}</td>
            <td>{{ producto.cajas }}</td>
            <td>{{ producto.saldo }}</td>
            <td>{{ producto.stock_fisico }}</td>
            <td>{{ producto.observacion }}</td>
            <td>{{ producto.fecha_venc }}</td>
            <td>{{ producto.fecha_imp }}</td>
            <td>{{ producto.contenedor }}</td>
            <td>{{ producto.fecha_inv }}</td>
            <td>{{ producto.encargado }}</td>
            
            <td>
                <a href="{% url 'productos:editar_producto' producto.id%}" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
                <a href="{% url 'productos:eliminar_producto' producto.id %}" class="btn btn-danger btn-sm"
                onclick="return confirm('¬øSeguro que deseas eliminar este registro?');">üóëÔ∏è Eliminar</a>

                
            </td>
        </tr>
        {% endfor %}
        </tboby>
        
    
    </table>

    
    
    
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function(){
        const input = document.getElementById('globalSearch');
        if(!input) return;
        const table = document.querySelector('table');
        const tbody = table ? table.tBodies[0] : null;
        input.addEventListener('input', function(e){
            const q = e.target.value.trim().toLowerCase();
            if(!tbody){
            return;
            }
            Array.from(tbody.rows).forEach(row=>{
            const text = row.textContent.toLowerCase();
            const match = text.indexOf(q) !== -1;
            row.style.display = match ? '' : 'none';
            });
        });
        // Atajo: presionar '/' para enfocar la b√∫squeda (opcional)
        document.addEventListener('keydown', function(e){
            if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
            e.preventDefault();
            input.focus();
            }
        });
        });
        </script>
        <!-- Librer√≠a ZXing -->
<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const startBtn = document.getElementById('startScan');
  const stopBtn = document.getElementById('stopScan');
  const status = document.getElementById('scanStatus');
  const video = document.getElementById('video');
  const container = document.getElementById('scannerContainer');
  const searchInput = document.getElementById('globalSearch');
  const codeReader = new ZXing.BrowserMultiFormatReader();

  let currentStream = null;
  let decoding = false;

  function logStatus(text) {
    status.textContent = text;
  }

  async function startScanner() {
    try {
      logStatus('Activando c√°mara...');
      startBtn.disabled = true;
      stopBtn.disabled = false;
      container.style.display = 'block';

      // Preferir c√°mara trasera
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });
      video.srcObject = stream;
      currentStream = stream;

      codeReader.decodeFromVideoElementContinuously(video, (result, err) => {
        if (result && !decoding) {
          decoding = true;
          const text = result.getText();
          logStatus('C√≥digo detectado: ' + text);
          searchInput.value = text;
          searchInput.dispatchEvent(new Event('input'));
          // si quieres detener autom√°ticamente:
          // stopScanner();
          decoding = false;
        }
      });
      logStatus('C√°mara activa (usa la trasera si est√° disponible)');
    } catch (err) {
      console.error(err);
      logStatus('Error al acceder a la c√°mara');
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  function stopScanner() {
    codeReader.reset();
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    container.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    logStatus('C√°mara detenida');
  }

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);
  window.addEventListener('pagehide', stopScanner);
});
</script>


            
    <!-- üîπ PAGINACI√ìN -->
    <nav aria-label="Paginaci√≥n">
      <ul class="pagination justify-content-center mt-3">
        {% if productos.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ productos.previous_page_number }}">Anterior</a>
          </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            P√°gina {{ productos.number }} de {{ productos.paginator.num_pages }}
          </span>
        </li>

        {% if productos.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ productos.next_page_number }}">Siguiente</a>
          </li>
        {% endif %}
      </ul>
    </nav>

            

{% endblock %}




